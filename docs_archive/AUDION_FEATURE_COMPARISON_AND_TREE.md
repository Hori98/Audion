# 🎧 新・Audion 機能差分分析＆実装仕様ツリー

## 📊 現状プロジェクト vs 新設計 差分分析

### 🔍 現状プロジェクトの実装状況調査

#### **既存タブ構成**（audion-app/app/(tabs)/）
- `index.tsx` - ホーム画面
- `feed.tsx` - フィード画面（記事選択・管理）
- `discover.tsx` - 発見・探索画面
- `playlist.tsx` - プレイリスト・ライブラリ画面
- `_layout.tsx` - タブナビゲーション設定

#### **既存の主要機能**（実装済み - 詳細分析結果）
1. ✅ **認証システム** - JWT Token, AuthContext実装済み
2. ✅ **記事取得・表示** - RSS統合、カテゴリ分類（AI）
3. ✅ **音声生成・再生** - OpenAI + Google TTS統合、複数生成方式
   - **AutoPick**: AI自動記事選択 (`/api/v2/audio/autopick`)
   - **Manual**: ユーザー手動選択 (`/api/v2/audio/manual`) 
   - **Schedule**: 予定配信（実装予定）
4. ✅ **プレイリスト機能** - 基本的な音声管理、「後で聴く」機能
5. ✅ **ユーザー設定** - 包括的設定システム（50+設定項目、7カテゴリ）
   - 言語設定（UI/音声独立）、テーマ、プロフィール、キャッシュ管理
   - Auto-Pick詳細設定、プロンプト設定、スケジュール配信設定
6. ✅ **サブスクリプション** - 3階層フリーミアムモデル（Free/Basic/Premium）
   - 記事数制限、音声品質、機能制限の詳細設定済み
7. ✅ **オフライン機能** - ダウンロード機能実装済み
8. ✅ **デバッグシステム** - 開発者向けAutoPickDebugMenu、プラン変更機能
9. ✅ **プロフィール管理** - アバター画像、統計情報、フォロー機能基盤
10. ✅ **アーカイブ・ブックマーク** - ArticleManagerService、ArchiveService統合

#### **複雑化した問題箇所**（新・回避すべき技術負債）
1. ❌ **server.py**: 5,653行の巨大ファイル、70個のAPIエンドポイント混在
   - **解決策**: 新設計では `/api/v1/` 構造でルーター分割（auth.py, articles.py, audio.py等）
2. ❌ **_layout.tsx**: 複雑なuseEffect、状態管理の混乱（337行、複雑な依存関係）
   - **解決策**: シンプルなタブナビゲーション、状態管理の一元化
3. ❌ **重複実装**: 同等機能の複数実装、一貫性の欠如
   - 例: 音声生成が `audio_unified.py`で統合されたが、旧実装も残存
4. ❌ **設定システムの分散**: 50+設定項目が複数ファイルに散在
   - **解決策**: 統一された設定管理システム、階層化設計
5. ❌ **サブスクリプション設定不整合**: 3つの設定場所での不一致
   - `SUBSCRIPTION_PLANS`, `base_limits`, `plan_multipliers` の同期問題

---

## 🎯 ベータ版 vs ローンチ版 機能分離

### 🚀 **ベータ版（Phase 1）** - 3ヶ月で達成
**目標**: 既存機能のクリーン再実装 + 安定性確保

#### **継承する機能**（既存から引き続き）
1. **ユーザー認証**
   - メール・パスワード認証
   - JWT Token管理
   - **差分**: よりシンプルな認証フロー、オンボーディング統合

2. **記事管理システム**
   - RSS記事取得・表示
   - カテゴリ分類（AI活用）
   - **差分**: UIの大幅簡素化、検索機能の強化

3. **音声生成・再生**
   - AI要約 + TTS音声化
   - 基本的な再生コントロール
   - **差分**: 生成プロセスの可視化、エラー処理強化

4. **「後で聴く」プレイリスト**
   - 基本的なプレイリスト機能
   - **差分**: シンプル化、ドラッグ&ドロップ対応

5. **基本設定**
   - 音声言語、再生速度
   - テーマ設定（ライト/ダーク）
   - **差分**: 設定項目の大幅整理、直感的UI

#### **削除する機能**（ベータ版では実装しない - 複雑性排除）
- ❌ **RSS管理機能**（複雑すぎる - `/sources`画面相当）
- ❌ **複数プレイリスト作成**（PLAYLIST_DESIGN_SPEC.mdの高度機能）
- ❌ **サブスクリプション制限**（FREEMIUM_PLAN_VARIABLES.mdの複雑な制限システム）
- ❌ **ソーシャル・シェア機能**（3点リーダーメニューの共有機能）
- ❌ **高度なプレイリスト機能**（AudioContextの拡張キュー管理）
- ❌ **プロンプト設定詳細**（複数プロンプトスタイル、カスタムプロンプト）
- ❌ **デバッグメニュー**（AutoPickDebugMenu、プラン変更機能）
- ❌ **アーカイブ管理**（削除済み記事管理、復元機能）
- ❌ **統計・分析機能**（ユーザープロフィールの詳細統計）

### 🌟 **ローンチ版（Phase 2）** - さらに6ヶ月で達成
**目標**: 一般ユーザー向けの完全機能

#### **新規追加機能**（既存高度機能をローンチ版で復活）
1. **RSS管理システム**（既存 `/sources` 画面の改良版）
   - カスタムRSS追加・編集・削除
   - おすすめRSS推薦機能
   - **理由**: ベータ版フィードバック後、UIを簡素化して実装

2. **高度プレイリスト**（PLAYLIST_DESIGN_SPEC.md準拠）
   - 複数の名前付きプレイリスト作成
   - 3点リーダーメニュー（共有、削除、キューイング）
   - AudioContext拡張キュー管理システム
   - **理由**: ユーザー需要確認後、段階的に実装

3. **Freemiumモデル**（FREEMIUM_PLAN_VARIABLES.md統合版）
   - 3階層制限システム（Free 3記事/日, Basic 5記事/日, Premium 15記事/日）
   - 統一された制限管理システム
   - 決済システム統合（Stripe/RevenueCat）
   - **理由**: ビジネスモデル検証後に実装

4. **ソーシャル機能**（既存フォロー機能の拡張）
   - プレイリスト共有・コミュニティ機能
   - ユーザープロフィール詳細統計
   - フォロー・フォロワーシステム完全版
   - **理由**: ユーザーベース確立後に実装

5. **プロンプト詳細設定**（既存 `/prompt-settings` の復活）
   - 複数プロンプトスタイル、カスタムプロンプト
   - **理由**: パワーユーザー向け機能として後期実装

---

## 🌳 **ベータ版機能仕様ツリー**（推論なし・実装レベル）

### 1. アプリ全体設計

#### 1.1 ビジュアルデザイン
- **テーマ**: Material Design 3（既存のExpo design systemから移行）
- **カラー**: 
  - Primary: #007AFF（既存Colors.tsから継承）
  - Secondary: #34C759
  - Background: システム標準（#F2F2F7 / #000000）
- **フォント**: システムデフォルト（iOS: SF Pro, Android: Roboto）
- **アイコン**: Ionicons（既存統一）

#### 1.2 技術スタック
- **フロントエンド**: React Native + Expo SDK 50（既存維持）
- **バックエンド**: FastAPI + PostgreSQL（MongoDBから移行）
- **認証**: JWT Token（既存方式維持）
- **音声**: Google TTS（既存維持）

---

### 2. ベータ版機能詳細仕様

#### **画面構成**: 4画面のシンプル構造
1. **認証・オンボーディング画面**
2. **ホーム画面**（記事一覧・音声生成）
3. **プレイヤー画面**（ミニ・フル画面）
4. **設定画面**

### **(画面1) 認証・オンボーディング**

#### **サブ画面: スプラッシュスクリーン**
- **(UI要素) ロゴアニメーション**
  - **機能**: Audionロゴ + 起動アニメーション
  - **トリガー**: アプリ起動時（自動）
  - **ロジック**: 
    1. ロゴ表示（フェードイン 0.5秒）
    2. JWT Token検証（AsyncStorage読み込み）
    3. 有効なら→ホーム画面、無効なら→認証画面
  - **データ**: AsyncStorage['jwt_token']
  - **画面遷移**: ホーム画面 or 認証画面
  - **実装**: `_layout.tsx`の認証チェックロジックをクリーン化

#### **サブ画面: 初回オンボーディング**
- **(UI要素) カテゴリ選択グリッド**
  - **機能**: 興味カテゴリ3-5個選択
  - **トリガー**: タイルタップ
  - **ロジック**:
    1. 固定11カテゴリを3×4グリッド表示
    2. 選択状態：border色変化 + チェックアイコン
    3. 3個未満選択時：「始める」ボタン無効化
    4. 選択完了時：`API.POST /onboarding/preferences`
  - **データ**: selectedCategories: string[]
  - **画面遷移**: ホーム画面
  - **実装**: 既存の`onboard.tsx`をベースに簡素化

#### **サブ画面: ログイン画面**
- **(UI要素) メールアドレス入力**
  - **機能**: メール形式検証付きテキスト入力
  - **トリガー**: フォーカス、文字入力、フォーカス離脱
  - **ロジック**:
    1. 入力値を正規表現検証（/^[^\s@]+@[^\s@]+\.[^\s@]+$/）
    2. 無効時：赤色border + エラーメッセージ
    3. 有効時：通常のborder色
  - **データ**: email: string
  - **画面遷移**: なし

- **(UI要素) パスワード入力**
  - **機能**: マスク付きパスワード入力、表示切替
  - **トリガー**: フォーカス、文字入力、目アイコンタップ
  - **ロジック**:
    1. デフォルト：secureTextEntry=true
    2. 目アイコンタップで表示/非表示切替
    3. 8文字未満：エラーメッセージ表示
  - **データ**: password: string, showPassword: boolean
  - **画面遷移**: なし

- **(UI要素) ログインボタン**
  - **機能**: 認証実行
  - **トリガー**: ボタンタップ
  - **ロジック**:
    1. メール・パスワード検証
    2. ローディング状態：disabled=true, ActivityIndicator表示
    3. `API.POST /auth/login` 実行
    4. 成功時：JWT tokenをAsyncStorageに保存、ホーム画面遷移
    5. 失敗時：エラーメッセージ表示、ローディング解除
  - **データ**: JWT token, user基本情報
  - **画面遷移**: ホーム画面（成功時）
  - **実装**: 既存AuthContextのlogin関数をクリーン化

### **(画面2) ホーム画面**

#### **メイン要素: 記事リスト**
- **(UI要素) 検索バー**
  - **機能**: 記事の全文検索
  - **トリガー**: フォーカス、文字入力
  - **ロジック**:
    1. 入力500ms後にAPI呼び出し（デバウンス処理）
    2. `API.GET /articles/search?q={query}` 実行
    3. 結果をリスト表示に反映
    4. 検索履歴をローカル保存（最大10件）
  - **データ**: searchQuery: string, searchResults: Article[]
  - **画面遷移**: なし
  - **実装**: 既存のSearchBar.tsxをベース簡素化

- **(UI要素) カテゴリフィルター**
  - **機能**: カテゴリ別記事フィルタリング
  - **トリガー**: タブタップ
  - **ロジック**:
    1. 横スクロールタブ表示（「全て」「Technology」「Business」...）
    2. アクティブタブ：背景色変化
    3. クライアントサイドフィルタリング（サーバー負荷軽減）
    4. フィルター結果をFlatListに反映
  - **データ**: activeCategory: string, filteredArticles: Article[]
  - **画面遷移**: なし
  - **実装**: 既存のGenreFilter.tsxをクリーン化

- **(UI要素) 記事カードリスト**
  - **機能**: 記事一覧表示、無限スクロール
  - **トリガー**: スクロール、カードタップ
  - **ロジック**:
    1. FlatListでページング実装（20件/ページ）
    2. スクロール末尾で`API.GET /articles?page={next}`
    3. カードタップで記事詳細モーダル表示
    4. プルリフレッシュで最新記事取得
  - **データ**: articles: Article[], currentPage: number, isLoading: boolean
  - **画面遷移**: 記事詳細モーダル
  - **実装**: 既存のUnifiedArticleList.tsxをベース簡素化

#### **記事カード内要素詳細**:
- **(子要素) サムネイル画像**
  - **機能**: 記事画像の表示、フォールバック処理
  - **ロジック**:
    1. Image.onError でフォールバック画像表示
    2. 読み込み中はSkeletonアニメーション
    3. 画像キャッシュ（FastImage使用）
  - **データ**: imageUrl: string, isImageLoading: boolean

- **(子要素) 記事タイトル**
  - **機能**: タイトル表示、長文省略
  - **ロジック**:
    1. Text numberOfLines=2 で2行制限
    2. ellipsizeMode="tail" で末尾省略

- **(子要素) メタ情報**
  - **機能**: ソース名、公開時刻、推定読み時間
  - **ロジック**:
    1. 公開時刻をmasterでDateFnsを使用して相対表示（"2時間前"）
    2. 読み時間 = 文字数 / 400文字/分 で算出

- **(子要素) アクションボタン**
  - **(音声生成ボタン)**
    - **機能**: 記事の音声化
    - **トリガー**: ボタンタップ
    - **ロジック**:
      1. `API.POST /audio/generate {article_id}` 実行
      2. WebSocket or Polling で生成進捗受信
      3. 完了時：自動的にプレイヤーで再生開始
      4. エラー時：エラーメッセージ表示
    - **データ**: generationStatus: 'idle' | 'generating' | 'completed' | 'error'
    - **画面遷移**: プレイヤー画面（生成完了時）
    - **実装**: 既存の音声生成機能をクリーン化

  - **(後で聴くボタン)**
    - **機能**: プレイリストに追加
    - **トリガー**: ボタンタップ
    - **ロジック**:
      1. ローカルプレイリスト（AsyncStorage）に追加
      2. 重複チェック：既存の場合はスキップ
      3. 視覚的フィードバック：ハート塗りつぶし + 小さなアニメーション
    - **データ**: playlistItems: string[], isAdded: boolean
    - **画面遷移**: なし

#### **記事詳細モーダル**:
- **(UI要素) 記事全文表示**
  - **機能**: スクロール可能な全文表示
  - **トリガー**: モーダル表示時
  - **ロジック**:
    1. 記事にcontentが含まれない場合は`API.GET /articles/{id}/content`
    2. HTMLをマークダウン風にレンダリング
    3. リンクタップで外部ブラウザ起動
  - **データ**: fullContent: string, isContentLoading: boolean

- **(UI要素) 音声操作パネル**
  - **機能**: モーダル内での音声生成・再生
  - **ロジック**: ホーム画面のアクションボタンと同様

### **(画面3) プレイヤー画面**

#### **ミニプレイヤー（全画面下部固定）**:
- **(UI要素) 現在再生情報**
  - **機能**: 再生中記事のタイトル・ソース表示
  - **トリガー**: 音声再生開始時
  - **ロジック**:
    1. 現在再生中の記事データを表示
    2. 長いタイトルはティッカースクロール
    3. タップでフルスクリーンプレイヤーに展開
  - **データ**: currentAudio: AudioItem
  - **画面遷移**: フルスクリーンプレイヤー

- **(UI要素) 基本再生コントロール**
  - **機能**: 再生・停止・スキップ操作
  - **トリガー**: ボタンタップ
  - **ロジック**:
    1. 再生/停止：Audio.playAsync() / Audio.pauseAsync()
    2. 10秒戻し：Audio.setPositionAsync(position - 10000)
    3. 10秒進み：Audio.setPositionAsync(position + 10000)
    4. プレイリスト次/前の記事に移動
  - **データ**: isPlaying: boolean, position: number, duration: number
  - **画面遷移**: なし
  - **実装**: 既存のBackgroundAudioServiceをクリーン化

- **(UI要素) 進行状況バー**
  - **機能**: 再生進行の表示・シーク操作
  - **トリガー**: 自動更新、ユーザードラッグ
  - **ロジック**:
    1. 1秒間隔で進行状況更新（useEffect + Timer）
    2. onSlidingStart でタイマー停止
    3. onValueChange でリアルタイム位置変更
    4. onSlidingComplete でAudio.setPositionAsync()実行
  - **データ**: progress: number (0-1), isDragging: boolean

#### **フルスクリーンプレイヤー**:
- **(UI要素) 大型記事サムネイル**
  - **機能**: 記事画像の大型表示
  - **ロジック**:
    1. 再生中は微細な拡大縮小アニメーション（音楽アプリ風）
    2. フォールバック：カテゴリ別デフォルト画像

- **(UI要素) 詳細情報表示**
  - **機能**: 記事タイトル、ソース、公開日時を詳細表示
  - **ロジック**: 複数行対応、自動改行

- **(UI要素) 拡張コントロール**
  - **機能**: 再生速度、リピート設定
  - **トリガー**: ボタンタップ
  - **ロジック**:
    1. 再生速度：0.5x, 0.75x, 1x, 1.25x, 1.5x, 2x を循環
    2. リピート：オフ, 全リピート, 1曲リピート
    3. 設定はAsyncStorageに保存

### **(画面4) 設定画面**

#### **設定項目を大幅簡素化**:
- **(UI要素) アカウント情報**
  - **機能**: プロフィール表示・編集
  - **実装**: 既存の複雑な設定を統合・簡素化

- **(UI要素) 音声設定**
  - **機能**: 言語（日/英）、デフォルト再生速度
  - **実装**: 既存の音声設定をクリーン化

- **(UI要素) テーマ設定**
  - **機能**: ライト/ダーク/システム追従
  - **実装**: 既存のThemeContextをクリーン化

- **(UI要素) ログアウト**
  - **機能**: 認証解除
  - **ロジック**:
    1. 確認ダイアログ表示
    2. AsyncStorageからJWT token削除
    3. 認証画面に遷移

---

## 🔄 データフロー・状態管理

### **Context構成**（既存をクリーン化）:
1. **AuthContext**: JWT token, ユーザー情報
2. **AudioContext**: 再生状態, プレイリスト
3. **ThemeContext**: テーマ設定
4. **削除**: 複雑なPersonalizationContextなど

### **API設計**（PostgreSQL移行）:
```
POST /auth/login
GET  /articles?page={}&category={}
GET  /articles/search?q={}
POST /audio/generate
GET  /user/profile
PUT  /user/preferences
```

### **データ永続化**:
- AsyncStorage: JWT token, ユーザー設定, プレイリスト
- サーバー: ユーザープロフィール, 音声ファイル, 記事データ

---

この仕様により、既存の複雑さを排除し、**推論なしで実装可能なレベルの詳細度**を達成します。ベータ版は既存機能のクリーン版として、確実に動作する安定版を3ヶ月で実現可能です。